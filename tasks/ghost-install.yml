---
- name: Make sure install dir exsists
  file:
    path: "{{ item['dir'] }}"
    state: directory

- name: Create Ghost user
  user:
    name: "{{ ghost_user }}"

- name: Install Ghost
  command:
    chdir: "{{ item.dir }}"
    cmd: "ghost install {{ item['type'] | default(omit) }} --no-setup"

- include_tasks: setup_mysql_database.yml
  when: "item['database'] is defined and 'mysql' in item['database']['client']"
  vars:
    mysql: "{{ item['database']['connection'] }}"

- name: Set storage object variable
  set_fact:
    storage: "{{ item['storage'] }}"
  when: item['storage'] is defined

- name: Create object storage bucket
  command:
    cmd: "s3cmd mb s3://{{ storage['bucket'] }}"
  when: storage is defined

- name: Install npm storage adapter
  npm:
    name: "{{ storage['npm_package'] }}"
    version: "{{ storage['npm_package_version'] | default('latest') }}"
    path: "{{ item['dir'] }}"
  when: storage is defined

- name: Create storage adapters dir
  file:
    path: "{{ item['dir'] }}/content/adapters/storage/"
    state: directory
  when: storage is defined

- name: Link storage adapter files
  file:
    src: "{{ item['dir'] }}/node_modules/{{ storage['npm_package'] }}"
    dest: "{{ item['dir'] }}/content/adapters/storage/{{ storage['npm_package'] }}"
    state: link
  when: storage is defined
