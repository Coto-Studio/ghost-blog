---
- hosts: all
  vars_files:
    - ./vagrant-test-site2-vars.yml

  pre_tasks:
    - name: "Add nodejs apt key"
      become: true
      apt_key:
        url: https://deb.nodesource.com/gpgkey/nodesource.gpg.key
        state: present

    - name: "Add nodejs 16.x ppa for apt repo"
      become: true
      apt_repository:
        repo: "deb https://deb.nodesource.com/node_{{ node_version }}.x bionic main"
        update_cache: yes

    - name: Update package manager cache
      become: true
      package:
        update_cache: true
        cache_valid_time: 3600
      register: updaded_packages

    - name: Upgrade system packages
      become: true
      package:
        upgrade: true
        autoremove: true
        autoclean: true
        cache_valid_time: 3600
      when: updaded_packages.changed

    - name: Install required packages
      become: true
      package:
        name:
          - mysql-server
          - nodejs
          - nginx
          - g++
          - python3
          - python3-pip
          - python3-dev
          - default-libmysqlclient-dev
          - build-essential
        state: present

  roles:
    - role: geerlingguy.mysql
      become: yes
    - role: ../../
      become: yes
